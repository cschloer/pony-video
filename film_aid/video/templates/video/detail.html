{% extends "base.html" %}

{% block content %}
<div class="card">
  <div class="card-body">
    <h5 class="card-title">{{ video.title }}</h5>
    <h6 class="card-subtitle mb-2 text-muted">Created by {{ video.user }} on {{ video.pub_date }}</h6>
    <p class="card-text">{{ video.description }}</p>
    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <div class="row">
        <div class="col-xl-8">
            <div id="player" style="width: 100%"></div>
        </div>


    <script>
      // 2. This code loads the IFrame Player API code asynchronously.
      console.log('{{ notes }}');
      var tag = document.createElement('script');
      // Calculate the ID from a video
      function getYouTubeId(url) {
          var regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
          var match = url.match(regExp);
          if (match && match[2].length == 11) {
              return match[2];
          } else {
              console.log('There was an error calculating the YouTube ID from the video');
              return -1
              //error
          }
      }

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      var player;
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '390',
          width: '640',
          videoId: getYouTubeId('{{ video.url }}'),
          events: {
            'onReady': onPlayerReady,
          }
        });
      }

      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        event.target.playVideo();
      }

    </script>

        <div class="col-xl-4">
        <script>
            var determineTimestamp = (ts) => {
                console.log('Got ts', ts);
                minute = Math.floor(ts / 60);
                second = ts % 60;
                console.log(minute, second);
                console.log(`${minute}:${second}`);
                return `${minute < 10 ? '0' + minute : minute}:${second < 10 ? '0' + second : second}`;
            }
            var seekToTs = (ts) => {
                console.log('seeking to ts', ts);
                player.seekTo(ts, true)
            }
        </script>
        {% for note in video.note_set.all %}
        <div class="row pb-1">
        <div class="btn-group" data-toggle="buttons">
            <button type="button" class="btn btn-primary" onclick="seekToTs({{ note.ts }})">
                <script>document.write(determineTimestamp({{ note.ts }}))</script>
            </button>
            <button
                type="button"
                class="btn btn-secondary"
                data-container="body"
                data-toggle="popover"
                data-placement="right"
                data-content="{{ note.description }}"
            >
                {{ note.title }}
            </button>
        </div>
        </div>
        {% endfor %}
        </div>
    </div>
  </div>
</div>
{% endblock %}
